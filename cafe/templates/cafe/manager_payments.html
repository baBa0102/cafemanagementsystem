{% extends 'base.html' %}
{% block title %}Payment Verification{% endblock %}
{% block content %}
<style>
.analytics-nav {
  display: flex;
  gap: 10px;
  margin-bottom: 20px;
  border-bottom: 2px solid #eee;
  padding-bottom: 10px;
}
.analytics-nav a {
  padding: 8px 16px;
  background: #f5f5f5;
  border-radius: 4px;
  text-decoration: none;
  color: #333;
  transition: all 0.3s;
}
.analytics-nav a:hover, .analytics-nav a.active {
  background: #2e7d32;
  color: white;
}
.payment-card {
  background: white;
  border: 1px solid #ddd;
  border-radius: 8px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.payment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-bottom: 15px;
  margin-bottom: 15px;
  border-bottom: 2px solid #f0f0f0;
}
.verify-btn {
  background: #2e7d32;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  margin-right: 8px;
  transition: all 0.3s;
}
.verify-btn:hover {
  background: #1b5e20;
}
.reject-btn {
  background: #d32f2f;
  color: white;
  border: none;
  padding: 8px 20px;
  border-radius: 4px;
  cursor: pointer;
  font-weight: bold;
  transition: all 0.3s;
}
.reject-btn:hover {
  background: #b71c1c;
}
.status-badge {
  padding: 6px 16px;
  border-radius: 20px;
  font-weight: bold;
  font-size: 14px;
  background: #fff3e0;
  color: #f57c00;
}
</style>

<h1>Payment Verification</h1>

<nav class="analytics-nav">
  <a href="{% url 'manager_dashboard' %}">Overview</a>
  <a href="{% url 'manager_payments' %}" class="active">Payment Verification</a>
  <a href="{% url 'manager_sales' %}">Sales Analytics</a>
  <a href="{% url 'manager_items' %}">Items Performance</a>
  <a href="{% url 'manager_customers' %}">Customer Insights</a>
</nav>

<div style="max-width: 1200px; margin: 0 auto;">
  {% if messages %}
    {% for message in messages %}
      <div style="padding: 15px; margin-bottom: 20px; border-radius: 4px; background: {% if message.tags == 'success' %}#e8f5e9; color: #2e7d32{% elif message.tags == 'warning' %}#fff3e0; color: #f57c00{% else %}#ffebee; color: #d32f2f{% endif %};">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <div style="background: #e3f2fd; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
    <h3 style="margin: 0 0 10px 0; color: #1976d2;">Quick Stats</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
      <div style="background: white; padding: 15px; border-radius: 4px;">
        <p style="margin: 0; font-size: 14px; color: #666;">Pending Payments</p>
        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #f57c00;">{{ payments_pending.count }}</p>
      </div>
      <div style="background: white; padding: 15px; border-radius: 4px;">
        <p style="margin: 0; font-size: 14px; color: #666;">Verified Today</p>
        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #2e7d32;">{{ verified_today }}</p>
      </div>
      <div style="background: white; padding: 15px; border-radius: 4px;">
        <p style="margin: 0; font-size: 14px; color: #666;">Total Amount Pending</p>
        <p style="margin: 5px 0 0 0; font-size: 24px; font-weight: bold; color: #1976d2;">₹{{ total_pending|floatformat:2 }}</p>
      </div>
    </div>
  </div>

  <h2>Pending Payment Verifications</h2>
  
  {% if payments_pending %}
    {% for payment in payments_pending %}
      <div class="payment-card">
        <div class="payment-header">
          <div>
            <h3 style="margin: 0;">Order #{{ payment.order.id }}</h3>
            <p style="margin: 5px 0 0 0; color: #666;">
              Customer: {{ payment.order.customer.name }} ({{ payment.order.customer.phone }})
            </p>
            <p style="margin: 5px 0 0 0; color: #666; font-size: 14px;">
              Placed: {{ payment.created_at|date:"F d, Y - g:i A" }}
            </p>
          </div>
          <div class="status-badge">
            {{ payment.get_status_display }}
          </div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px;">
          <div>
            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Order Details</h4>
            <p style="margin: 5px 0;"><strong>Amount:</strong> ₹{{ payment.amount|floatformat:2 }}</p>
            <p style="margin: 5px 0;"><strong>Order Type:</strong> {{ payment.order.get_order_type_display }}</p>
            {% if payment.order.table_no %}
              <p style="margin: 5px 0;"><strong>Table:</strong> {{ payment.order.table_no }}</p>
            {% endif %}
            {% if payment.order.delivery_address %}
              <p style="margin: 5px 0;"><strong>Address:</strong> {{ payment.order.delivery_address.line1 }}, {{ payment.order.delivery_address.city }}</p>
            {% endif %}
          </div>
          
          <div>
            <h4 style="margin: 0 0 10px 0; font-size: 14px; color: #666;">Payment Information</h4>
            <p style="margin: 5px 0;"><strong>Reference:</strong> {{ payment.reference|default:"Not provided" }}</p>
            <p style="margin: 5px 0;"><strong>Status:</strong> {{ payment.get_status_display }}</p>
            <p style="margin: 5px 0;"><strong>Submitted:</strong> {{ payment.created_at|date:"g:i A" }}</p>
          </div>
        </div>
        
        <div style="background: #f9f9f9; padding: 15px; border-radius: 4px; margin-bottom: 15px;">
          <h4 style="margin: 0 0 10px 0; font-size: 14px;">Order Items</h4>
          {% for item in payment.order.items.all %}
            <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
              <span>{{ item.item.name }} x {{ item.quantity }}</span>
              <span><strong>₹{{ item.subtotal|floatformat:2 }}</strong></span>
            </div>
          {% endfor %}
          <div style="display: flex; justify-content: space-between; padding: 10px 0 0 0; font-size: 16px; font-weight: bold;">
            <span>Total:</span>
            <span style="color: #2e7d32;">₹{{ payment.order.total_amount|floatformat:2 }}</span>
          </div>
        </div>
        
        <div style="display: flex; gap: 10px; justify-content: flex-end;">
          <form method="post" action="{% url 'verify_payment' payment.id %}" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="action" value="verify">
            <button type="submit" class="verify-btn" onclick="return confirm('Verify payment for Order #{{ payment.order.id }}?')">
              ✓ Verify Payment
            </button>
          </form>
          
          <form method="post" action="{% url 'verify_payment' payment.id %}" style="display: inline;">
            {% csrf_token %}
            <input type="hidden" name="action" value="reject">
            <button type="submit" class="reject-btn" onclick="return confirm('Reject payment for Order #{{ payment.order.id }}? This will cancel the order.')">
              ✗ Reject Payment
            </button>
          </form>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div style="text-align: center; padding: 60px 20px; background: #f5f5f5; border-radius: 8px;">
      <h2 style="color: #666;">✓ All Caught Up!</h2>
      <p style="color: #999;">No payments pending verification at the moment.</p>
    </div>
  {% endif %}
  
  <div style="margin-top: 30px; text-align: center;">
    <a href="{% url 'manager_dashboard' %}" style="color: #2e7d32; text-decoration: none;">← Back to Dashboard</a>
  </div>
</div>

<script>
// Auto-refresh every 30 seconds to check for new payments
setTimeout(function() {
  location.reload();
}, 30000);
</script>
{% endblock %}
